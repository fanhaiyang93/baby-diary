/**
 * ÁÖßÁâá‰∏ä‰º†ÂíåÂ§ÑÁêÜÂäüËÉΩ
 * ÊîØÊåÅÊú¨Âú∞ÁÖßÁâáÂéãÁº©„ÄÅ‰ºòÂåñÂíåÈ¢ÑËßà
 */

class PhotoUploader {
    constructor() {
        this.maxWidth = 1200;
        this.maxHeight = 800;
        this.quality = 0.8;
        this.maxFileSize = 5 * 1024 * 1024; // 5MB
        this.supportedFormats = ['image/jpeg', 'image/png', 'image/webp'];
        this.processedPhotos = [];
    }

    /**
     * ÂàùÂßãÂåñ‰∏ä‰º†ÂäüËÉΩ
     */
    init() {
        this.setupEventListeners();
        console.log('ÁÖßÁâá‰∏ä‰º†ÂäüËÉΩÂ∑≤ÂàùÂßãÂåñ üì∏');
    }

    /**
     * ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
     */
    setupEventListeners() {
        const uploadArea = document.getElementById('upload-area');
        const photoInput = document.getElementById('photo-input');

        if (!uploadArea || !photoInput) {
            console.warn('‰∏ä‰º†Âå∫ÂüüÊàñÊñá‰ª∂ËæìÂÖ•Ê°ÜÊú™ÊâæÂà∞');
            return;
        }

        // ÊãñÊãΩ‰∫ã‰ª∂
        uploadArea.addEventListener('dragover', this.handleDragOver.bind(this));
        uploadArea.addEventListener('dragleave', this.handleDragLeave.bind(this));
        uploadArea.addEventListener('drop', this.handleDrop.bind(this));

        // Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂
        photoInput.addEventListener('change', this.handleFileSelect.bind(this));
    }

    /**
     * Â§ÑÁêÜÊãñÊãΩÊÇ¨ÂÅú
     */
    handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        e.currentTarget.classList.add('dragover');
    }

    /**
     * Â§ÑÁêÜÊãñÊãΩÁ¶ªÂºÄ
     */
    handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        e.currentTarget.classList.remove('dragover');
    }

    /**
     * Â§ÑÁêÜÊñá‰ª∂ÊãñÊãΩÊîæÁΩÆ
     */
    handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        e.currentTarget.classList.remove('dragover');

        const files = Array.from(e.dataTransfer.files).filter(file => 
            this.supportedFormats.includes(file.type)
        );

        if (files.length > 0) {
            this.processFiles(files);
        } else {
            this.showMessage('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂ÔºàJPEG„ÄÅPNG„ÄÅWebPÔºâ', 'warning');
        }
    }

    /**
     * Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
     */
    handleFileSelect(e) {
        const files = Array.from(e.target.files);
        this.processFiles(files);
    }

    /**
     * Â§ÑÁêÜÊñá‰ª∂ÂàóË°®
     */
    async processFiles(files) {
        const validFiles = files.filter(file => {
            if (!this.supportedFormats.includes(file.type)) {
                this.showMessage(`‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè: ${file.name}`, 'warning');
                return false;
            }
            if (file.size > this.maxFileSize) {
                this.showMessage(`Êñá‰ª∂ËøáÂ§ß: ${file.name} (${this.formatFileSize(file.size)})`, 'warning');
                return false;
            }
            return true;
        });

        if (validFiles.length === 0) {
            return;
        }

        this.showMessage(`Ê≠£Âú®Â§ÑÁêÜ ${validFiles.length} Âº†ÁÖßÁâá...`, 'info');
        
        for (const file of validFiles) {
            try {
                const processedPhoto = await this.processPhoto(file);
                this.processedPhotos.push(processedPhoto);
            } catch (error) {
                console.error('Â§ÑÁêÜÁÖßÁâáÂ§±Ë¥•:', error);
                this.showMessage(`Â§ÑÁêÜÂ§±Ë¥•: ${file.name}`, 'error');
            }
        }

        this.updatePreview();
        this.showPreviewArea();
    }

    /**
     * Â§ÑÁêÜÂçïÂº†ÁÖßÁâá
     */
    async processPhoto(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    try {
                        const canvas = this.resizeImage(img);
                        canvas.toBlob((blob) => {
                            const processedFile = new File([blob], this.generateFileName(file.name), {
                                type: 'image/jpeg',
                                lastModified: Date.now()
                            });
                            
                            resolve({
                                original: file,
                                processed: processedFile,
                                preview: canvas.toDataURL('image/jpeg', 0.7),
                                dimensions: {
                                    original: { width: img.width, height: img.height },
                                    processed: { width: canvas.width, height: canvas.height }
                                },
                                compression: ((file.size - processedFile.size) / file.size * 100).toFixed(1)
                            });
                        }, 'image/jpeg', this.quality);
                    } catch (error) {
                        reject(error);
                    }
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    /**
     * Ë∞ÉÊï¥ÂõæÁâáÂ∞∫ÂØ∏
     */
    resizeImage(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // ËÆ°ÁÆóÊñ∞Â∞∫ÂØ∏
        let { width, height } = this.calculateNewDimensions(img.width, img.height);
        
        canvas.width = width;
        canvas.height = height;

        // ÁªòÂà∂ÂõæÁâá
        ctx.drawImage(img, 0, 0, width, height);
        
        return canvas;
    }

    /**
     * ËÆ°ÁÆóÊñ∞ÁöÑÂõæÁâáÂ∞∫ÂØ∏
     */
    calculateNewDimensions(originalWidth, originalHeight) {
        let width = originalWidth;
        let height = originalHeight;

        // Â¶ÇÊûúÂõæÁâáÂ∞∫ÂØ∏Ë∂ÖËøáÊúÄÂ§ßÈôêÂà∂ÔºåÊåâÊØî‰æãÁº©Êîæ
        if (width > this.maxWidth || height > this.maxHeight) {
            const aspectRatio = width / height;
            
            if (width > height) {
                width = this.maxWidth;
                height = width / aspectRatio;
            } else {
                height = this.maxHeight;
                width = height * aspectRatio;
            }
        }

        return { width: Math.round(width), height: Math.round(height) };
    }

    /**
     * ÁîüÊàêÊñ∞ÁöÑÊñá‰ª∂Âêç
     */
    generateFileName(originalName) {
        const timestamp = new Date().toISOString().slice(0, 10);
        const baseName = originalName.replace(/\.[^/.]+$/, '');
        return `${baseName}-optimized-${timestamp}.jpg`;
    }

    /**
     * Êõ¥Êñ∞È¢ÑËßàÂå∫Âüü
     */
    updatePreview() {
        const previewGrid = document.getElementById('preview-grid');
        if (!previewGrid) return;

        previewGrid.innerHTML = '';

        this.processedPhotos.forEach((photo, index) => {
            const previewItem = this.createPreviewItem(photo, index);
            previewGrid.appendChild(previewItem);
        });
    }

    /**
     * ÂàõÂª∫È¢ÑËßàÈ°π
     */
    createPreviewItem(photo, index) {
        const item = document.createElement('div');
        item.className = 'preview-item';
        item.innerHTML = `
            <div class="preview-image-container">
                <img src="${photo.preview}" alt="${photo.processed.name}" class="preview-image">
                <button class="preview-remove" onclick="photoUploader.removePhoto(${index})" title="Âà†Èô§">
                    <span>√ó</span>
                </button>
            </div>
            <div class="preview-info">
                <div class="preview-name" title="${photo.processed.name}">${photo.processed.name}</div>
                <div class="preview-details">
                    <div class="preview-size">
                        <span class="size-label">ÂéüÂßã:</span> ${this.formatFileSize(photo.original.size)}
                    </div>
                    <div class="preview-size">
                        <span class="size-label">‰ºòÂåñ:</span> ${this.formatFileSize(photo.processed.size)}
                    </div>
                    <div class="preview-compression">
                        <span class="compression-label">ÂéãÁº©:</span> ${photo.compression}%
                    </div>
                </div>
                <div class="preview-dimensions">
                    <div class="dimension-item">
                        <span class="dim-label">ÂéüÂßã:</span> ${photo.dimensions.original.width}√ó${photo.dimensions.original.height}
                    </div>
                    <div class="dimension-item">
                        <span class="dim-label">‰ºòÂåñ:</span> ${photo.dimensions.processed.width}√ó${photo.dimensions.processed.height}
                    </div>
                </div>
            </div>
        `;
        return item;
    }

    /**
     * Âà†Èô§ÁÖßÁâá
     */
    removePhoto(index) {
        this.processedPhotos.splice(index, 1);
        this.updatePreview();
        
        if (this.processedPhotos.length === 0) {
            this.hidePreviewArea();
        }
    }

    /**
     * ÊòæÁ§∫È¢ÑËßàÂå∫Âüü
     */
    showPreviewArea() {
        const previewArea = document.getElementById('preview-area');
        if (previewArea) {
            previewArea.style.display = 'block';
        }
    }

    /**
     * ÈöêËóèÈ¢ÑËßàÂå∫Âüü
     */
    hidePreviewArea() {
        const previewArea = document.getElementById('preview-area');
        if (previewArea) {
            previewArea.style.display = 'none';
        }
    }

    /**
     * ‰∏ãËΩΩÊâÄÊúâÂ§ÑÁêÜÂêéÁöÑÁÖßÁâá
     */
    downloadAllPhotos() {
        if (this.processedPhotos.length === 0) {
            this.showMessage('Ê≤°ÊúâÂèØ‰∏ãËΩΩÁöÑÁÖßÁâá', 'warning');
            return;
        }

        this.processedPhotos.forEach((photo, index) => {
            setTimeout(() => {
                this.downloadPhoto(photo.processed, photo.processed.name);
            }, index * 100); // Âª∂Ëøü‰∏ãËΩΩÈÅøÂÖçÊµèËßàÂô®ÈòªÊ≠¢
        });

        this.showMessage(`ÂºÄÂßã‰∏ãËΩΩ ${this.processedPhotos.length} Âº†‰ºòÂåñÂêéÁöÑÁÖßÁâá`, 'success');
    }

    /**
     * ‰∏ãËΩΩÂçïÂº†ÁÖßÁâá
     */
    downloadPhoto(file, filename) {
        const url = URL.createObjectURL(file);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /**
     * Ê∏ÖÁ©∫ÊâÄÊúâÁÖßÁâá
     */
    clearAllPhotos() {
        this.processedPhotos = [];
        this.updatePreview();
        this.hidePreviewArea();
        
        // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•Ê°Ü
        const photoInput = document.getElementById('photo-input');
        if (photoInput) {
            photoInput.value = '';
        }
        
        this.showMessage('Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâÁÖßÁâá', 'info');
    }

    /**
     * ÁîüÊàê‰ΩøÁî®ÊåáÂçó
     */
    generateUsageGuide() {
        if (this.processedPhotos.length === 0) {
            this.showMessage('ËØ∑ÂÖàÂ§ÑÁêÜ‰∏Ä‰∫õÁÖßÁâá', 'warning');
            return;
        }

        let guide = '# ÁÖßÁâá‰ΩøÁî®ÊåáÂçó\n\n';
        guide += '## Êñá‰ª∂ÂàóË°®\n\n';
        
        this.processedPhotos.forEach((photo, index) => {
            guide += `${index + 1}. **${photo.processed.name}**\n`;
            guide += `   - ÂéüÂßãÂ∞∫ÂØ∏: ${photo.dimensions.original.width}√ó${photo.dimensions.original.height}\n`;
            guide += `   - ‰ºòÂåñÂ∞∫ÂØ∏: ${photo.dimensions.processed.width}√ó${photo.dimensions.processed.height}\n`;
            guide += `   - Êñá‰ª∂Â§ßÂ∞è: ${this.formatFileSize(photo.processed.size)}\n`;
            guide += `   - ÂéãÁº©Áéá: ${photo.compression}%\n\n`;
        });
        
        guide += '## ‰ΩøÁî®Ê≠•È™§\n\n';
        guide += '1. Â∞Ü‰ºòÂåñÂêéÁöÑÁÖßÁâá‰øùÂ≠òÂà∞È°πÁõÆÁöÑ `assets/images/photos/` ÁõÆÂΩï\n';
        guide += '2. Âú® `photos.html` È°µÈù¢‰∏≠Ê∑ªÂä†Áõ∏Â∫îÁöÑHTML‰ª£Á†Å\n';
        guide += '3. Êèê‰∫§Êõ¥ÊîπÂà∞GitHub‰ªìÂ∫ì\n\n';
        guide += '## HTML‰ª£Á†ÅÁ§∫‰æã\n\n';
        guide += '```html\n';
        
        this.processedPhotos.forEach((photo) => {
            const filename = photo.processed.name;
            guide += `<div class="photo-item">\n`;
            guide += `    <img src="/assets/images/photos/${filename}" alt="ÁÖßÁâáÊèèËø∞">\n`;
            guide += `    <div class="photo-info">\n`;
            guide += `        <h3 class="photo-title">ÁÖßÁâáÊ†áÈ¢ò</h3>\n`;
            guide += `        <p class="photo-description">ÁÖßÁâáÊèèËø∞</p>\n`;
            guide += `        <div class="photo-meta">\n`;
            guide += `            <span class="photo-date">ÊãçÊëÑÊó•Êúü</span>\n`;
            guide += `            <span class="photo-tags">Ê†áÁ≠æ</span>\n`;
            guide += `        </div>\n`;
            guide += `    </div>\n`;
            guide += `</div>\n\n`;
        });
        
        guide += '```\n';
        
        this.downloadTextFile(guide, 'photo-usage-guide.md');
        this.showMessage('‰ΩøÁî®ÊåáÂçóÂ∑≤ÁîüÊàêÂπ∂‰∏ãËΩΩ', 'success');
    }

    /**
     * ‰∏ãËΩΩÊñáÊú¨Êñá‰ª∂
     */
    downloadTextFile(content, filename) {
        const blob = new Blob([content], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /**
     * Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
     */
    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    /**
     * ÊòæÁ§∫Ê∂àÊÅØ
     */
    showMessage(message, type = 'info') {
        // ÂàõÂª∫Ê∂àÊÅØÂÖÉÁ¥†
        const messageEl = document.createElement('div');
        messageEl.className = `upload-message upload-message-${type}`;
        messageEl.textContent = message;
        
        // Ê∑ªÂä†Âà∞È°µÈù¢
        const container = document.querySelector('.method-container') || document.body;
        container.appendChild(messageEl);
        
        // Ëá™Âä®ÁßªÈô§
        setTimeout(() => {
            if (messageEl.parentNode) {
                messageEl.parentNode.removeChild(messageEl);
            }
        }, 3000);
    }
}

// ÂÖ®Â±ÄÂÆû‰æã
let photoUploader;

// ÂÖ®Â±ÄÂáΩÊï∞Ôºà‰æõHTMLË∞ÉÁî®Ôºâ
window.processPhotos = function() {
    if (!photoUploader || photoUploader.processedPhotos.length === 0) {
        alert('ËØ∑ÂÖàÈÄâÊã©ÁÖßÁâá');
        return;
    }
    
    photoUploader.downloadAllPhotos();
};

window.clearPhotos = function() {
    if (photoUploader) {
        photoUploader.clearAllPhotos();
    }
};

window.generateGuide = function() {
    if (photoUploader) {
        photoUploader.generateUsageGuide();
    }
};

// È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', function() {
    photoUploader = new PhotoUploader();
    photoUploader.init();
});

// ÂØºÂá∫‰æõÂÖ∂‰ªñÊ®°Âùó‰ΩøÁî®
if (typeof module !== 'undefined' && module.exports) {
    module.exports = PhotoUploader;
}